<div class="modal-backdrop" (click)="onBackdropClick($event)">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <button class="back-button" (click)="closeModal()" type="button">
        <svg width="7" height="10" viewBox="0 0 7 10" fill="none">
          <path d="M6 1L2 5L6 9" stroke="currentColor" stroke-width="2"/>
        </svg>
        <span>Go back</span>
      </button>
      <h2 class="modal-title">
        {{ isEditMode ? 'Edit' : 'New Invoice' }}
      </h2>
    </div>

    <form [formGroup]="invoiceForm" class="invoice-form">
      <!-- Bill From Section -->
      <section class="form-section">
        <h3 class="section-title">Bill From</h3>
        <div class="form-group" formGroupName="senderAddress">
          <label class="form-label">Street Address</label>
          <input 
            type="text" 
            formControlName="street" 
            class="form-input"
            [class.error]="invoiceForm.get('senderAddress.street')?.invalid && invoiceForm.get('senderAddress.street')?.touched"
          />
          @if (invoiceForm.get('senderAddress.street')?.invalid && invoiceForm.get('senderAddress.street')?.touched) {
            <span class="error-message">Can't be empty</span>
          }
        </div>
        <div class="form-row">
          <div class="form-group" formGroupName="senderAddress">
            <label class="form-label">City</label>
            <input 
              type="text" 
              formControlName="city" 
              class="form-input"
              [class.error]="invoiceForm.get('senderAddress.city')?.invalid && invoiceForm.get('senderAddress.city')?.touched"
            />
            @if (invoiceForm.get('senderAddress.city')?.invalid && invoiceForm.get('senderAddress.city')?.touched) {
              <span class="error-message">Can't be empty</span>
            }
          </div>
          <div class="form-group" formGroupName="senderAddress">
            <label class="form-label">Post Code</label>
            <input 
              type="text" 
              formControlName="postCode" 
              class="form-input"
              [class.error]="invoiceForm.get('senderAddress.postCode')?.invalid && invoiceForm.get('senderAddress.postCode')?.touched"
            />
            @if (invoiceForm.get('senderAddress.postCode')?.invalid && invoiceForm.get('senderAddress.postCode')?.touched) {
              <span class="error-message">Can't be empty</span>
            }
          </div>
          <div class="form-group" formGroupName="senderAddress">
            <label class="form-label">Country</label>
            <input 
              type="text" 
              formControlName="country" 
              class="form-input"
              [class.error]="invoiceForm.get('senderAddress.country')?.invalid && invoiceForm.get('senderAddress.country')?.touched"
            />
            @if (invoiceForm.get('senderAddress.country')?.invalid && invoiceForm.get('senderAddress.country')?.touched) {
              <span class="error-message">Can't be empty</span>
            }
          </div>
        </div>
      </section>

      <!-- Bill To Section -->
      <section class="form-section">
        <h3 class="section-title">Bill To</h3>
        <div class="form-group">
          <label class="form-label">Client's Name</label>
          <input 
            type="text" 
            formControlName="clientName" 
            class="form-input"
            [class.error]="invoiceForm.get('clientName')?.invalid && invoiceForm.get('clientName')?.touched"
          />
          @if (invoiceForm.get('clientName')?.invalid && invoiceForm.get('clientName')?.touched) {
            <span class="error-message">Can't be empty</span>
          }
        </div>
        <div class="form-group">
          <label class="form-label">Client's Email</label>
          <input 
            type="email" 
            formControlName="clientEmail" 
            class="form-input"
            [class.error]="invoiceForm.get('clientEmail')?.invalid && invoiceForm.get('clientEmail')?.touched"
          />
          @if (invoiceForm.get('clientEmail')?.invalid && invoiceForm.get('clientEmail')?.touched) {
            <span class="error-message">
              {{ invoiceForm.get('clientEmail')?.errors?.['email'] ? 'Invalid email' : "Can't be empty" }}
            </span>
          }
        </div>
        <div class="form-group" formGroupName="clientAddress">
          <label class="form-label">Street Address</label>
          <input 
            type="text" 
            formControlName="street" 
            class="form-input"
            [class.error]="invoiceForm.get('clientAddress.street')?.invalid && invoiceForm.get('clientAddress.street')?.touched"
          />
          @if (invoiceForm.get('clientAddress.street')?.invalid && invoiceForm.get('clientAddress.street')?.touched) {
            <span class="error-message">Can't be empty</span>
          }
        </div>
        <div class="form-row">
          <div class="form-group" formGroupName="clientAddress">
            <label class="form-label">City</label>
            <input 
              type="text" 
              formControlName="city" 
              class="form-input"
              [class.error]="invoiceForm.get('clientAddress.city')?.invalid && invoiceForm.get('clientAddress.city')?.touched"
            />
            @if (invoiceForm.get('clientAddress.city')?.invalid && invoiceForm.get('clientAddress.city')?.touched) {
              <span class="error-message">Can't be empty</span>
            }
          </div>
          <div class="form-group" formGroupName="clientAddress">
            <label class="form-label">Post Code</label>
            <input 
              type="text" 
              formControlName="postCode" 
              class="form-input"
              [class.error]="invoiceForm.get('clientAddress.postCode')?.invalid && invoiceForm.get('clientAddress.postCode')?.touched"
            />
            @if (invoiceForm.get('clientAddress.postCode')?.invalid && invoiceForm.get('clientAddress.postCode')?.touched) {
              <span class="error-message">Can't be empty</span>
            }
          </div>
          <div class="form-group" formGroupName="clientAddress">
            <label class="form-label">Country</label>
            <input 
              type="text" 
              formControlName="country" 
              class="form-input"
              [class.error]="invoiceForm.get('clientAddress.country')?.invalid && invoiceForm.get('clientAddress.country')?.touched"
            />
            @if (invoiceForm.get('clientAddress.country')?.invalid && invoiceForm.get('clientAddress.country')?.touched) {
              <span class="error-message">Can't be empty</span>
            }
          </div>
        </div>
      </section>

      <!-- Invoice Details Section -->
      <section class="form-section">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Invoice Date</label>
            <input 
              type="date" 
              formControlName="createdAt" 
              class="form-input"
              [class.error]="invoiceForm.get('createdAt')?.invalid && invoiceForm.get('createdAt')?.touched"
            />
            @if (invoiceForm.get('createdAt')?.invalid && invoiceForm.get('createdAt')?.touched) {
              <span class="error-message">Can't be empty</span>
            }
          </div>
          <div class="form-group">
            <label class="form-label">Payment Terms</label>
            <select 
              formControlName="paymentTerms" 
              class="form-input"
              [class.error]="invoiceForm.get('paymentTerms')?.invalid && invoiceForm.get('paymentTerms')?.touched"
            >
              <option value="1">Net 1 Day</option>
              <option value="7">Net 7 Days</option>
              <option value="14">Net 14 Days</option>
              <option value="30">Net 30 Days</option>
            </select>
            @if (invoiceForm.get('paymentTerms')?.invalid && invoiceForm.get('paymentTerms')?.touched) {
              <span class="error-message">Can't be empty</span>
            }
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Project Description</label>
          <input 
            type="text" 
            formControlName="description" 
            class="form-input"
            [class.error]="invoiceForm.get('description')?.invalid && invoiceForm.get('description')?.touched"
          />
          @if (invoiceForm.get('description')?.invalid && invoiceForm.get('description')?.touched) {
            <span class="error-message">Can't be empty</span>
          }
        </div>
      </section>

      <!-- Item List Section -->
      <section class="form-section">
        <h3 class="section-title">Item List</h3>
        <div class="items-list">
          @for (item of lineItems.controls; track $index) {
            <div class="item-row" [formGroup]="$any(item)">
              <div class="item-field">
                <label class="form-label">Item Name</label>
                <input 
                  type="text" 
                  formControlName="name" 
                  class="form-input"
                  [class.error]="item.get('name')?.invalid && item.get('name')?.touched"
                />
              </div>
              <div class="item-field">
                <label class="form-label">Qty.</label>
                <input 
                  type="number" 
                  formControlName="quantity" 
                  class="form-input"
                  min="1"
                  [class.error]="item.get('quantity')?.invalid && item.get('quantity')?.touched"
                />
              </div>
              <div class="item-field">
                <label class="form-label">Price</label>
                <input 
                  type="number" 
                  formControlName="price" 
                  class="form-input"
                  min="0"
                  step="0.01"
                  [class.error]="item.get('price')?.invalid && item.get('price')?.touched"
                />
              </div>
              <div class="item-field total-field">
                <label class="form-label">Total</label>
                <div class="item-total">Â£{{ getLineItemTotal($index) | number: '1.2-2' }}</div>
              </div>
              <button 
                type="button" 
                class="delete-item-button" 
                (click)="removeLineItem($index)"
                [disabled]="lineItems.length === 1"
              >
                <svg width="13" height="16" viewBox="0 0 13 16" fill="none">
                  <path d="M8.44442 0.999985V0.333318H4.55553V0.999985H1.11108V2.33332H11.8889V0.999985H8.44442ZM2.33331 3.66665V14.3333C2.33331 15.2538 3.07953 15.9999 3.99998 15.9999H9.00002C9.92047 15.9999 10.6666 15.2538 10.6666 14.3333V3.66665H2.33331ZM4.66664 6.33332H6.00002V13.6666H4.66664V6.33332ZM7.00002 6.33332H8.33336V13.6666H7.00002V6.33332Z" fill="#888EB0"/>
                </svg>
              </button>
            </div>
          }
        </div>
        <button 
          type="button" 
          class="add-item-button" 
          (click)="addLineItem()"
        >
          + Add New Item
        </button>
      </section>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="form-actions-left">
          @if (isEditMode) {
            <button 
              type="button" 
              class="btn-delete" 
              (click)="showDeleteConfirm.set(true)"
            >
              Delete
            </button>
          }
        </div>
        <div class="form-actions-right">
          <button 
            type="button" 
            class="btn-discard" 
            (click)="closeModal()"
          >
            {{ isEditMode ? 'Cancel' : 'Discard' }}
          </button>
          <button 
            type="button" 
            class="btn-draft" 
            (click)="onSaveAsDraft()"
          >
            Save as Draft
          </button>
          <button 
            type="button" 
            class="btn-save" 
            (click)="onSaveAndSend()"
          >
            {{ isEditMode ? 'Save Changes' : 'Save & Send' }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm()) {
  <div class="delete-modal-backdrop" (click)="showDeleteConfirm.set(false)">
    <div class="delete-modal" (click)="$event.stopPropagation()">
      <h3 class="delete-modal-title">Confirm Deletion</h3>
      <p class="delete-modal-text">
        Are you sure you want to delete invoice #{{ invoice?.id }}? This action cannot be undone.
      </p>
      <div class="delete-modal-actions">
        <button 
          type="button" 
          class="btn-cancel" 
          (click)="showDeleteConfirm.set(false)"
        >
          Cancel
        </button>
        <button 
          type="button" 
          class="btn-delete-confirm" 
          (click)="onDelete()"
        >
          Delete
        </button>
      </div>
    </div>
  </div>
}

